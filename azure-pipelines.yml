trigger: none

pool: vky

stages:

# ---------------- Terraform Install & Init ----------------
- stage: Terraform_install
  displayName: Terraform Install & Init
  jobs:
  - job: Terraform_init
    displayName: Terraform init
    steps:

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        backendServiceArm: 'vky_serviceconnection'
        backendAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
        backendAzureRmResourceGroupName: 'vky'
        backendAzureRmStorageAccountName: 'keystroke111111'
        backendAzureRmContainerName: 'mysecrettffile'
        backendAzureRmKey: 'secretfile1.tfstate'


# ---------------- Terraform Plan ----------------

  - job: Terraform_plan
    displayName: Terraform plan
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'
    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        backendServiceArm: 'vky_serviceconnection'
        backendAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
        backendAzureRmResourceGroupName: 'vky'
        backendAzureRmStorageAccountName: 'keystroke111111'
        backendAzureRmContainerName: 'mysecrettffile'
        backendAzureRmKey: 'secretfile1.tfstate'

    - task: TerraformTask@5
      displayName: Terraform plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        commandOptions: '-var-file="terraform.tfvars"'
        environmentServiceNameAzureRM: 'vky_serviceconnection'
        environmentAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'


# ---------------- Terraform Apply ----------------
- stage: Terraform_apply
  displayName: Terraform Apply
  dependsOn: Terraform_install
  jobs:

  - job: Terraform_apply
    displayName: Terraform init & apply
    steps:

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        backendServiceArm: 'vky_serviceconnection'
        backendAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
        backendAzureRmResourceGroupName: 'vky'
        backendAzureRmStorageAccountName: 'keystroke111111'
        backendAzureRmContainerName: 'mysecrettffile'
        backendAzureRmKey: 'secretfile1.tfstate'

    - task: TerraformTask@5
      displayName: Terraform apply
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'vky_serviceconnection'
        environmentAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'

    # âš  Normally destroy alag pipeline me hota hai
    - task: TerraformTask@5
      displayName: Terraform destroy
      inputs:
        provider: 'azurerm'
        command: 'destroy'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'vky_serviceconnection'
        environmentAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
