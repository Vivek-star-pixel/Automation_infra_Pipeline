trigger: none

pool: vky

stages:

# ---------------- Terraform Install & Init ----------------
- stage: Terraform_install
  displayName: Terraform Install & Init
  jobs:
  - job: Terraform_init
    displayName: Terraform init
    steps:

    # tfsec
    - task: tfsec@1
      inputs:
        version: 'v1.26.0'
        debug: true

    # Terraform install
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    # ✅ TFLint install


    - task: PowerShell@2
      displayName: Install TFLint
      inputs:
        targetType: 'inline'
        script: |
          $version = "v0.54.0"
          $url = "https://github.com/terraform-linters/tflint/releases/download/$version/tflint_windows_amd64.zip"
          $out = "$env:TEMP\tflint.zip"
          $dest = "$env:AGENT_TOOLSDIRECTORY\tflint"

          Write-Host "Downloading TFLint..."
          Invoke-WebRequest -Uri $url -OutFile $out

          Write-Host "Extracting..."
          Expand-Archive $out -DestinationPath $dest -Force

          Write-Host "Adding to PATH..."
          Write-Host "##vso[task.prependpath]$dest"

          tflint --version



    # ✅ TFLint run
    - task: PowerShell@2
      displayName: Run TFLint
      inputs:
        targetType: 'inline'
        script: |
          cd ENV/dev
          tflint --init
          tflint
         

    # Terraform init
    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        backendServiceArm: 'vky_serviceconnection'
        backendAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
        backendAzureRmResourceGroupName: 'vky'
        backendAzureRmStorageAccountName: 'keystroke111111'
        backendAzureRmContainerName: 'mysecrettffile'
        backendAzureRmKey: 'secretfile1.tfstate'


# ---------------- Terraform Plan ----------------

  - job: Terraform_plan
    displayName: Terraform plan
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'
    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        backendServiceArm: 'vky_serviceconnection'
        backendAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
        backendAzureRmResourceGroupName: 'vky'
        backendAzureRmStorageAccountName: 'keystroke111111'
        backendAzureRmContainerName: 'mysecrettffile'
        backendAzureRmKey: 'secretfile1.tfstate'

    - task: TerraformTask@5
      displayName: Terraform plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        commandOptions: '-var-file="terraform.tfvars"'
        environmentServiceNameAzureRM: 'vky_serviceconnection'
        environmentAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'


# ---------------- Terraform Apply ----------------
- stage: Manual_validation
  pool: server
  displayName: Manual_validation
  dependsOn: Terraform_install
  jobs:

  - job: Terraform_manual_validation
    displayName: Terraform validate
    steps:
    - task: ManualValidation@1
      inputs:
        notifyUsers: 'mohkarvivek99@gmail.com'
        approvers: 'mohkarvivek99@gmail.com'
        instructions: 'Without any delay, pls approve'



# ---------------- Terraform Apply ----------------
- stage: Terraform_apply
  displayName: Terraform Apply
  dependsOn: Manual_validation
  jobs:

  - job: Terraform_apply
    displayName: Terraform init & apply
    steps:

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        backendServiceArm: 'vky_serviceconnection'
        backendAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
        backendAzureRmResourceGroupName: 'vky'
        backendAzureRmStorageAccountName: 'keystroke111111'
        backendAzureRmContainerName: 'mysecrettffile'
        backendAzureRmKey: 'secretfile1.tfstate'

    - task: TerraformTask@5
      displayName: Terraform apply
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'vky_serviceconnection'
        environmentAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'

    # ⚠ Normally destroy alag pipeline me hota hai
    - task: TerraformTask@5
      displayName: Terraform destroy
      inputs:
        provider: 'azurerm'
        command: 'destroy'
        workingDirectory: '$(System.DefaultWorkingDirectory)/ENV/dev'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'vky_serviceconnection'
        environmentAzureRmOverrideSubscriptionID: '7e450572-1056-4117-9e7b-97e717138408'
